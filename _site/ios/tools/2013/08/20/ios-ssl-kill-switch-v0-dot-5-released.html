<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>iOS SSL Kill Switch v0.5 Released</title>
      <meta name="viewport" content="width=device-width">
      <!-- syntax highlighting CSS -->
      <link rel="stylesheet" href="/css/syntax.css">
      <!-- Custom CSS -->
      <link rel="stylesheet" href="/css/main.css">
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-47756501-1', 'isecpartners.github.io');
        ga('send', 'pageview');

      </script>
   </head>
   <body>
      <div id="container">
         <div class="inner">

               <header>
               <img src="/images/iseclogo.png">
               <h2 class="title">iSEC Research Labs</h2>
               <div id="navbar">
               <a class="extra" href="/">Home</a> |
               <a class="extra" href="/blog">Archives</a> |
               <a class="extra" href="/tools">Tools</a> |
               <a class="extra" href="/research">Research</a>
               </div>
              </header>

            <section id="/ios/tools/2013/08/20/ios-ssl-kill-switch-v0-dot-5-released" class="main_content">
               <!-- Blog post-->
<div>
	<h2>iOS SSL Kill Switch v0.5 Released</h2>
    <h6>20 Aug 2013 - Alban Diquet</h6>
</div>

<div lang="en" class="post">
<p>Version 0.5 of the <a href="http://nabla-c0d3.github.io/blog/2012/08/12/ios-ssl-kill-switch-released/">iOS SSL Kill Switch</a> is now available.
iOS SSL Kill Switch is a tool to disable SSL certificate validation -
including certificate pinning - within iOS Apps in order to facilitate
blackbox testing. </p>

<p>The main goal for this version was to add the ability to <a href="https://github.com/iSECPartners/ios-ssl-kill-switch/issues/6">disable
certification within the iTunes App Store app</a>. While working on
this feature, I discovered a new way to disable certificate validation that
worked on many more applications than previous versions of the tweak.
As a consequence, version 0.5 of the SSL Kill Switch is a complete rewrite.</p>

<p><strong>The debian package is available <a href="https://www.dropbox.com/s/p81z1l0ygnl35vw/com.isecpartners.nabla.sslkillswitch_v0.5-iOS_6.1.deb?dl=1">here</a></strong> and was tested on iOS 6.1.
Instructions on how to install it are available on the <a href="https://github.com/iSECPartners/ios-ssl-kill-switch">project page</a>.</p>

<h3>How it works</h3>

<p>Just like the previous versions of the tool, the SSL Kill Switch uses <a href="http://iphonedevwiki.net/index.php/MobileSubstrate">MobileSubstrate</a>
to patch system functions. However, this new version of the tweak hooks
functions within the <a href="https://developer.apple.com/library/ios/DOCUMENTATION/Security/Reference/secureTransportRef/Reference/reference.html">Secure Transport API </a> instead of
hooking <em>NSURLConnection</em> methods and <em>SecTrustEvaluate()</em>.</p>

<p>The Secure Transport API is &quot;the lowest-level TLS implementation on iOS&quot;
which makes it an interesting target because other higher level APIs such as
<em>NSURLConnection</em> internally rely on the Secure Transport API for their
certificate validation routines. This means that disabling SSL certificate
validation in the Secure Transport API should affect most (if not all) of the
network APIs available within the iOS framework.</p>

<p>According to the <a href="https://developer.apple.com/library/ios/technotes/tn2232/_index.html#//apple_ref/doc/uid/DTS40012884-CH1-SECSECURETRANSPORT">documentation</a>, disabling or performing 
custom certificate validation is implemented the following way when using the 
Secure Transport API:</p>

<ol>
<li>Before starting the connection, call <em>SSLSetSessionOption()</em> to set the <em>kSSLSessionOptionBreakOnServerAuth</em> option to &quot;true&quot; on the SSL context. Setting this option to &quot;true&quot; disables the framework&#39;s built-in certificate validation to let the application perform its own certificate verification.</li>
<li>Run the Secure Transport handshake as per usual using the <em>SSLHandshake()</em> function.</li>
<li>When <em>SSLHandshake()</em> returns <em>errSSLServerAuthCompleted</em>, call <em>SSLCopyPeerTrust()</em> to get a trust object for the connection and use that trust object to implement whatever custom server trust evaluation you desire.</li>
<li>Either continue the Secure Transport handshake by calling <em>SSLHandshake()</em> again, or shut down the connection.</li>
</ol>

<p>The SSL Kill Switch removes the ability to do any kind of certificate
validation by hooking and modifying three functions within the <a href="https://developer.apple.com/library/ios/DOCUMENTATION/Security/Reference/secureTransportRef/Reference/reference.html">Secure
Transport API</a>.</p>

<h4>Patch <em>SSLCreateContext()</em>: Disable the built-in certificate validation in all SSL contexts</h4>

<p><em>SSLCreateContext()</em> is used to create a new SSL context. SSL Kill Switch modifies this function 
so that all new SSL contexts have the <em>kSSLSessionOptionBreakOnServerAuth</em> set to true 
by default:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">static SSLContextRef replaced_SSLCreateContext (
   CFAllocatorRef alloc,
   SSLProtocolSide protocolSide,
   SSLConnectionType connectionType
) {
    SSLContextRef sslContext = original_SSLCreateContext(alloc, protocolSide, connectionType);

    // Immediately set the kSSLSessionOptionBreakOnServerAuth option in order to disable cert validation
    original_SSLSetSessionOption(sslContext, kSSLSessionOptionBreakOnServerAuth, true);
    return sslContext;
}
</code></pre></div>
<h4>Patch <em>SSLSetSessionOption()</em>: Remove the ability to re-enable the built-in certificate validation</h4>

<p><em>SSLSetSessionOption()</em> can be called to set the value of specific options on a given SSL context. The tweak
patches this function in order to prevent the <em>kSSLSessionOptionBreakOnServerAuth</em> from being set to any value.
The goal here is to ensure that all SSL contexts keep the default value of &quot;true&quot; for the 
<em>kSSLSessionOptionBreakOnServerAuth</em> option (as set in the previous section):</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">static OSStatus replaced_SSLSetSessionOption(
    SSLContextRef context, 
    SSLSessionOption option, 
    Boolean value
 ) {
    // Remove the ability to modify the value of the kSSLSessionOptionBreakOnServerAuth option
    if (option == kSSLSessionOptionBreakOnServerAuth)
        return noErr;
    else
        return original_SSLSetSessionOption(context, option, value);
}
</code></pre></div>
<h4>Patch <em>SSLHandshake()</em>: Force a trust-all custom certificate validation</h4>

<p>Lastly, <em>SSLHandshake()</em> is modified in order to prevent this function from ever returning
<em>errSSLServerAuthCompleted</em>, which is the return value that will trigger the caller&#39;s certificate
checking/pinning code:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">static OSStatus replaced_SSLHandshake(
    SSLContextRef context
) {
    OSStatus result = original_SSLHandshake(context);

    // Hijack the flow when breaking on server authentication
    if (result == errSSLServerAuthCompleted) {
        // Do not check the cert and call SSLHandshake() again
        return original_SSLHandshake(context);
    }
    else
        return result;
}
</code></pre></div>
<p>That&#39;s it ! After patching those three functions, certificate validation was disabled in all
the applications that I tried including Safari, Twitter, Square as well as the iTune App 
Store (<a href="http://nabla-c0d3.github.io/blog/2013/08/20/intercepting-the-app-stores-traffic-on-ios/">with a few additional steps</a>).</p>

<h3>Project page</h3>

<p>Have a look at the full code by browsing to the <a href="https://github.com/iSECPartners/ios-ssl-kill-switch">project page</a> on GitHub.</p>

</div>


<!-- Links to previous/next posts -->
<div class="postswitch">


  <h6 class="navpost "><span class="right"> &raquo; </span> <a class="navright" href="/femtocell/blackhat/2013/08/19/femtocell-slides.html" title="Previous Post: Black Hat 2013 - Femtocell Presentation Slides, Videos and App">Black Hat 2013 - Femtocell Presentation Slides, Videos and App</a></h6>




  <h6 class="navpost"> <span>&laquo;</span> <a class="navleft"  href="/ios/tools/2013/08/21/introspy-release.html" title="Next Post: Blackbox iOS App Analysis with Introspy">Blackbox iOS App Analysis with Introspy</a></h6>


</div>


            </section>


            <footer style="clear: both;">
               <div> iSEC Partners 2014 -
                     <a href="https://github.com/isecpartners/">iSEC on GitHub</a> -
                     <a href="https://www.isecpartners.com/about/careers.aspx">Join us!</a>
               </div>
            </footer>
         </div>
      </div>
      <!-- /container -->
   </body>
</html>
